name: Build Blender 3.6 for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Usar Python 3.10 preinstalado en el runner
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      # Instalar dependencias del sistema
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y git cmake ninja-build pkg-config \
            libxi-dev libxxf86vm-dev libxfixes-dev libxrender-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev libegl1-mesa-dev \
            libwayland-dev wayland-protocols libxkbcommon-dev \
            libdbus-1-dev libpulse-dev libasound2-dev libvulkan-dev \
            libjpeg-dev libpng-dev libtiff-dev libopenexr-dev \
            libfftw3-dev libopenal-dev libglew-dev libsdl2-dev \
            libepoxy-dev libfreetype-dev libfontconfig1-dev \
            python3-numpy

      # Clonar Blender 3.6
      - name: Clone Blender 3.6
        run: |
          git clone https://github.com/blender/blender.git --branch blender-v3.6-release --depth 1
          cd blender
          make update

      # Configurar build usando Python 3.10 del runner
      - name: Configure build
        run: |
          cd blender
          mkdir -p build_linux
          cd build_linux
          cmake .. \
            -DWITH_CYCLES_DEVICE_CUDA=OFF \
            -DWITH_CYCLES_DEVICE_OPTIX=OFF \
            -DPYTHON_VERSION=3.10 \
            -DPYTHON_EXECUTABLE=$(which python) \
            -DPYTHON_LIBRARY=$(python -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR')+'/libpython3.10.so')") \
            -DPYTHON_INCLUDE_DIR=$(python -c "from sysconfig import get_paths; print(get_paths()['include'])") \
            -DPYTHON_INCLUDE_CONFIG_DIR=$(python -c "from sysconfig import get_paths; print(get_paths()['platinclude'])")

      # Compilar Blender
      - name: Build Blender
        run: |
          cd blender/build_linux
          make -j$(nproc)

      # Empaquetar en zip
      - name: Package APK
        run: |
          cd blender/build_linux
          mkdir -p ../../output
          zip -r ../../Blender-3.6-Android.zip .
          cd ../..
          mv Blender-3.6-Android.zip ${{ github.workspace }}/Blender-3.6-Android.zip

      # Subir artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Blender-3.6-Android
          path: Blender-3.6-Android.zip
